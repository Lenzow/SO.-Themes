{{ 'consign-dashboard.css' | asset_url | stylesheet_tag }}

<!-- External Libraries (CDN) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.default.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<div class="consign-dashboard-wrapper">
  {% comment %} Hero Banner {% endcomment %}
  {% if section.settings.show_hero %}
    <div
      class="consign-banner"
      style="
        background-image: url('{{ section.settings.banner_bg | image_url: width: 2000 }}');
        background-color: #999;
        height: {{ section.settings.banner_height }}px;
      "
    >
      <div class="consign-banner-text">
        <h1
          class="h2 ls-1 mb-2"
          style="text-transform: none !important; color: {{ section.settings.color_title }};"
        >
          {{ section.settings.hero_title }}
        </h1>
        <p
          class="body-font ls-05 opacity-80"
          style="color: {{ section.settings.color_text }};"
        >
          {{ section.settings.hero_text | newline_to_br }}
        </p>
      </div>
    </div>
  {% endif %}

  <div class="container container--medium">
    <div class="form-container">
      <form id="ConsignForm" enctype="multipart/form-data">
        <div class="form-section fade-in">
          <h3 class="step-header">1. Select Collection</h3>
          <div class="chip-group mb-4">
            <label class="chip">
              <input type="radio" name="contact[Collection]" value="Bags" checked onchange="updateBrandList('Bags')">
              <span>Bags</span>
            </label>
            <label class="chip">
              <input type="radio" name="contact[Collection]" value="Clothes" onchange="updateBrandList('Clothes')">
              <span>Clothes</span>
            </label>
            <label class="chip">
              <input type="radio" name="contact[Collection]" value="Shoes" onchange="updateBrandList('Shoes')">
              <span>Shoes</span>
            </label>
            <label class="chip">
              <input
                type="radio"
                name="contact[Collection]"
                value="Accessories"
                onchange="updateBrandList('Accessories')"
              >
              <span>Accessories</span>
            </label>
            <label class="chip">
              <input
                type="radio"
                name="contact[Collection]"
                value="Fine Jewelry"
                onchange="updateBrandList('Fine Jewelry')"
              >
              <span>Fine Jewelry</span>
            </label>
            <label class="chip">
              <input type="radio" name="contact[Collection]" value="Watches" onchange="updateBrandList('Watches')">
              <span>Watches</span>
            </label>
            <label class="chip">
              <input
                type="radio"
                name="contact[Collection]"
                value="Home & Art"
                onchange="updateBrandList('Home & Art')"
              >
              <span>Home & Art</span>
            </label>
            <label class="chip">
              <input type="radio" name="contact[Collection]" value="Other" onchange="updateBrandList('Other')">
              <span>Other</span>
            </label>
          </div>

          <div class="grid-2">
            <div class="form-group" style="grid-column: span 2;">
              <label class="form-label step-header">2. Brand *</label>
              <select
                id="brand-select"
                name="contact[Brand]"
                class=""
                required
                placeholder="Search or select a brand..."
              >
                <option value="">Select Brand</option>
                <!-- Populated by JS -->
              </select>
              <input
                type="text"
                id="brand-other-input"
                name="contact[Brand_Custom]"
                class="form-input mt-2"
                placeholder="Enter brand name"
                style="display:none;"
              >
            </div>
          </div>

          <div class="form-group mt-3">
            <label class="form-label step-header">3. Condition *</label>
            <div class="condition-grid">
              <label class="condition-card">
                <input type="radio" name="contact[Condition]" value="New / Never Used" checked>
                <div class="condition-content">
                  <span class="condition-title">New / Never Used</span>
                  <span class="condition-desc">Never been worn, with or without tags.</span>
                </div>
              </label>
              <label class="condition-card">
                <input type="radio" name="contact[Condition]" value="Excellent">
                <div class="condition-content">
                  <span class="condition-title">Excellent</span>
                  <span class="condition-desc">Worn a few times, minimal signs of use.</span>
                </div>
              </label>
              <label class="condition-card">
                <input type="radio" name="contact[Condition]" value="Good">
                <div class="condition-content">
                  <span class="condition-title">Good</span>
                  <span class="condition-desc">Light signs of use, overall good condition.</span>
                </div>
              </label>
              <label class="condition-card">
                <input type="radio" name="contact[Condition]" value="Acceptable">
                <div class="condition-content">
                  <span class="condition-title">Acceptable</span>
                  <span class="condition-desc">Visible signs of use, still wearable.</span>
                </div>
              </label>
            </div>
          </div>

          <div class="form-group mt-4">
            <label class="form-label step-header">4. Description (Optional)</label>
            <textarea
              name="contact[Description]"
              class="form-input"
              rows="3"
              placeholder="Model, year, size, color, inclusions..."
            ></textarea>
          </div>
        </div>

        <div class="form-section mt-5 fade-in" style="animation-delay: 0.1s;">
          <h3 class="step-header mb-1">5. Photos</h3>
          <p class="body-font small-text mb-2 opacity-60">Upload clear photos (Front & Back required).</p>

          <div class="upload-grid">
            <!-- Front (Required) -->
            <div id="upload-box-front" class="upload-box" onclick="triggerFile('file-front')">
              <input
                type="file"
                id="file-front"
                name="file_front"
                accept="image/png, image/jpeg, image/webp"
                hidden
                onchange="previewFile(this, 'preview-front')"
              >
              <div class="upload-placeholder" id="preview-front-placeholder">
                <span class="plus-icon">+</span>
                <span class="upload-label">Front *</span>
              </div>
              <img id="preview-front" class="upload-preview" src="" style="display:none">
              <button type="button" class="remove-btn" onclick="removeFile(event, 'file-front', 'preview-front')">
                ×
              </button>
            </div>

            <!-- Back (Required) -->
            <div id="upload-box-back" class="upload-box" onclick="triggerFile('file-back')">
              <input
                type="file"
                id="file-back"
                name="file_back"
                accept="image/png, image/jpeg, image/webp"
                hidden
                onchange="previewFile(this, 'preview-back')"
              >
              <div class="upload-placeholder" id="preview-back-placeholder">
                <span class="plus-icon">+</span>
                <span class="upload-label">Back *</span>
              </div>
              <img id="preview-back" class="upload-preview" src="" style="display:none">
              <button type="button" class="remove-btn" onclick="removeFile(event, 'file-back', 'preview-back')">
                ×
              </button>
            </div>

            <!-- Side -->
            <div id="upload-box-side" class="upload-box" onclick="triggerFile('file-side')">
              <input
                type="file"
                id="file-side"
                name="file_side"
                accept="image/png, image/jpeg, image/webp"
                hidden
                onchange="previewFile(this, 'preview-side')"
              >
              <div class="upload-placeholder" id="preview-side-placeholder">
                <span class="plus-icon">+</span>
                <span class="upload-label">Side</span>
              </div>
              <img id="preview-side" class="upload-preview" src="" style="display:none">
              <button type="button" class="remove-btn" onclick="removeFile(event, 'file-side', 'preview-side')">
                ×
              </button>
            </div>

            <!-- Inside -->
            <div id="upload-box-inside" class="upload-box" onclick="triggerFile('file-inside')">
              <input
                type="file"
                id="file-inside"
                name="file_inside"
                accept="image/png, image/jpeg, image/webp"
                hidden
                onchange="previewFile(this, 'preview-inside')"
              >
              <div class="upload-placeholder" id="preview-inside-placeholder">
                <span class="plus-icon">+</span>
                <span class="upload-label">Inside</span>
              </div>
              <img id="preview-inside" class="upload-preview" src="" style="display:none">
              <button type="button" class="remove-btn" onclick="removeFile(event, 'file-inside', 'preview-inside')">
                ×
              </button>
            </div>

            <!-- Details -->
            <div id="upload-box-details" class="upload-box" onclick="triggerFile('file-details')">
              <input
                type="file"
                id="file-details"
                name="file_details"
                accept="image/png, image/jpeg, image/webp"
                hidden
                onchange="previewFile(this, 'preview-details')"
              >
              <div class="upload-placeholder" id="preview-details-placeholder">
                <span class="plus-icon">+</span>
                <span class="upload-label">Details</span>
              </div>
              <img id="preview-details" class="upload-preview" src="" style="display:none">
              <button type="button" class="remove-btn" onclick="removeFile(event, 'file-details', 'preview-details')">
                ×
              </button>
            </div>
          </div>
        </div>

        <div class="form-section mt-5 fade-in" style="animation-delay: 0.2s;">
          <h3 class="step-header mb-3">6. Contact Info</h3>
          <div class="form-group mb-3">
            <label class="form-label">Name *</label>
            <input type="text" name="contact[name]" class="form-input" placeholder="Your Name" required>
          </div>

          <div class="grid-2">
            <div class="form-group">
              <label class="form-label">Phone *</label>
              <input
                type="tel"
                id="contact-phone"
                name="contact[phone_raw]"
                class="form-input"
                required
                placeholder=""
                style="padding-left: 90px !important;"
              >
              <input type="hidden" name="contact[phone]" id="real-phone-input">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" name="contact[email]" class="form-input" placeholder="Your Email">
            </div>
          </div>

          <div class="sidebar-inline mt-4 p-3 bg-light" style="border-radius:2px;">
            <p class="small-text mb-0" style="color:#666; line-height:1.5;">
              <strong>Note:</strong> We review every submission within 24 hours. Once you approve the price, you can
              ship your item or drop it off at the boutique.
            </p>
          </div>

          <!-- Honeypot -->
          <div style="display:none; overflow:hidden; height:0;">
            <input type="text" name="honeypot_check" tabindex="-1" autocomplete="off">
          </div>
        </div>

        <div class="form-actions mt-5 border-top pt-4">
          <button
            type="submit"
            id="submitBtn"
            class="btn btn-black btn-block text-uppercase ls-1"
            style="height:56px; background-color: #000 !important; color: #fff !important; border-radius: 4px;"
          >
            <span>Submit Item</span>
            <svg
              style="width:20px; height:20px; margin-left:10px;"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% comment %} States: Loading & Success (Hidden by default) {% endcomment %}
<div id="consign-loading" class="consign-overlay">
  <div class="spinner"></div>
  <p class="mt-3 font-bold text-uppercase ls-1">Submitting Item...</p>
</div>

<div id="consign-success" class="consign-overlay" style="background:#fff;">
  <div class="success-content text-center p-4">
    <svg
      style="width:50px; height:50px; color:#1a1a1a; margin-bottom:20px;"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
    </svg>
    <h2 class="h4 mb-2 text-uppercase">Submission Received</h2>
    <p class="body-font opacity-70 mb-1">
      Reference: <span id="success-ref-id" class="font-weight-bold text-black">SBS-####</span>
    </p>
    <p class="body-font opacity-70" style="max-width:320px; margin:15px auto 25px;">
      We will review your item and contact you within 24 hours with pricing guidance.
    </p>
    <a
      id="success-whatsapp-link"
      href="#"
      class="btn btn-black text-uppercase ls-1"
      style="width:100%; height:50px; line-height:50px; background-color: #000 !important; color: #fff !important; display:block;"
      >Continue on WhatsApp</a
    >
    <br>
    <a href="" class="link-underline small-text mt-3 d-inline-block" onclick="location.reload()">Submit Another Item</a>
  </div>
</div>

<div id="toast-container" class="toast-container"></div>

<script>
  // BRAND DATA MAPPING
  const brandData = {
    Accessories: [
      'Aigner',
      'Alexander McQueen',
      'Alfred Dunhill',
      'Audemars Piguet',
      'Balenciaga',
      'Boss By Hugo Boss',
      'Bottega Veneta',
      'Boucheron',
      'Brioni',
      'Brunello Cucinelli',
      'Burberry',
      'Burberry Brit',
      'Burberry London',
      'Burberry Prorsum',
      'Bvlgari',
      "Caran d'Ache",
      'Carolina Herrera',
      'Cartier',
      'Celine',
      'CH Carolina Herrera',
      'Chanel',
      'Charriol',
      'Chaumet',
      'Chopard',
      'Christian Louboutin',
      'Coach',
      'Cole Haan',
      'D&G',
      'Delvaux',
      'Dior',
      'Dolce & Gabbana',
      'Dsquared2',
      'Dunhill',
      'Emporio Armani',
      'Ermenegildo Zegna',
      'Etro',
      'Fendi',
      'Franck Muller',
      'Gianfranco Ferre',
      'Giorgio Armani',
      'Givenchy',
      'Goyard',
      'Gucci',
      'Harry Winston',
      'Hermes',
      'Hublot',
      'Hysek',
      'Jimmy Choo',
      'Lanvin',
      'Linda Farrow',
      'Loewe',
      'Loro Piana',
      'Louis Vuitton',
      'Marc by Marc Jacobs',
      'Maurice Lacroix',
      'McQ by Alexander McQueen',
      'Michael Kors',
      'Miu Miu',
      'Monique Lhuillier',
      'Montblanc',
      'Montegrappa',
      'Moschino',
      'Pomellato',
      'Porsche Design',
      'Prada',
      'Ralph Lauren',
      'Ralph Lauren Purple Label',
      'Roberto Cavalli',
      'Rolex',
      'S.T. Dupont',
      'Saint Laurent Paris',
      'Salvatore Ferragamo',
      'Smythson',
      'Thierry Lasry',
      'Tiffany & Co.',
      "Tod's",
      'Tom Ford',
      'TUMI',
      'Valentino',
      'Valextra',
      'Van Cleef & Arpels',
      'Versace',
      'Yves Saint Laurent',
      'Brand Not Listed',
    ],
    Bags: [
      'Acne Studios',
      'Alexander McQueen',
      'Alfred Dunhill',
      'Alviero Martini 1A Classe',
      'Amiri',
      'Balenciaga',
      'Bally',
      'Berluti',
      'Bottega Veneta',
      'Burberry',
      'Burberry Brit',
      'Burberry London',
      'Burberry Prorsum',
      'Bvlgari',
      'Carolina Herrera',
      'Cartier',
      'Celine',
      'CH Carolina Herrera',
      'Chanel',
      'Coach',
      'D&G',
      'Delvaux',
      'Dior',
      'Dkny',
      'Dolce & Gabbana',
      'Dries van Noten',
      'Dunhill',
      'Ermenegildo Zegna',
      'Escada',
      'Etro',
      'Fendi',
      'Gianfranco Ferre',
      'Giorgio Armani',
      'Givenchy',
      'Globe-Trotter',
      'Goyard',
      'Gucci',
      'Gucci x Balenciaga',
      'Hermes',
      'Issey Miyake',
      'J.W.Anderson',
      'Jil Sander',
      'Karl Lagerfeld',
      'Kenzo',
      'Loewe',
      'Longchamp',
      'Loro Piana',
      'Louis Vuitton',
      'Marc by Marc Jacobs',
      'McQ by Alexander McQueen',
      'Miu Miu',
      'Moncler',
      'Montblanc',
      'Off-White',
      'Paul and Joe',
      'Polo Ralph Lauren',
      'Porsche Design',
      'Prada',
      'Prada Sport',
      'Rimowa',
      'S.T. Dupont',
      'Saint Laurent Paris',
      'Salvatore Ferragamo',
      "Tod's",
      'TUMI',
      'Valentino',
      'Valextra',
      'Versace',
      'Vivienne Westwood',
      'Yves Saint Laurent',
      'Brand Not Listed',
    ],
    Clothes: [
      '424',
      'A Bathing Ape',
      'A Cold Wall',
      'Acne Studios',
      'Aime Leon Dore',
      'Alexander McQueen',
      'All Saints',
      'Amiri',
      'Armani Collezioni',
      'Axel Arigato',
      'Balenciaga',
      'Balenciaga Golf',
      'Balmain',
      'Bape',
      'Bode',
      'Boss By Hugo Boss',
      'Boss Orange by Hugo Boss',
      'Bottega Veneta',
      'Boutique Moschino',
      'Brunello Cucinelli',
      'Burberry',
      'Burberry Brit',
      'Burberry Golf',
      'Burberry London',
      'Burberry Prorsum',
      'Burberry Sport',
      'Calvin Klein',
      'Canada Goose',
      'Casablanca',
      'CH Carolina Herrera',
      'Chanel',
      'Christian Dior SPORTS',
      'Class by Roberto Cavalli',
      'CLOT',
      'Craig Green',
      'D&G',
      'Dior',
      'Dolce & Gabbana',
      'Dolce & Gabbana Mare',
      'Dolce & Gabbana St. Tropez',
      'Dries van Noten',
      'Dsquared2',
      'Emporio Armani',
      'Ermenegildo Zegna',
      'Etro',
      'Fear of God',
      'Fendi',
      'Fendi Jeans',
      'Flagstuff',
      'GCDS',
      'Gianni Versace',
      'Giorgio Armani',
      'Givenchy',
      'GmBH',
      'Gucci',
      'Gucci Viaggio',
      'Hermes',
      'Heron Preston',
      'Hugo Boss',
      'Human Made',
      'IRO',
      'Issey Miyake Homme Plisse',
      'Jacquemus',
      'Jil Sander',
      'John Elliott',
      'Junya Watanabe Comme Des Garcon Man',
      'Just Cavalli',
      'Kenzo',
      'Kenzo Homme',
      'Kenzo Jeans',
      'Kenzo Sports',
      'Kiko Kostadinov',
      'Kith',
      'Lanvin',
      'Loewe',
      'Loro Piana',
      'Louis Vuitton',
      'Love Moschino',
      'Marcelo Burlon',
      'Martine Rose',
      'Mary Katrantzou',
      'Mastermind World',
      'McQ by Alexander McQueen',
      'Moncler',
      'Moncler Grenoble',
      'Monfrere',
      'Monique Lhuillier',
      'Moschino',
      'Moschino Cheap and Chic',
      'Moschino Couture',
      'Moschino Jeans',
      'Neil Barrett',
      'Noah NYC',
      'Notte By Marchesa',
      'Off-White',
      'Palace',
      'Palm Angels',
      'Patta',
      'Polo Ralph Lauren',
      'Prada',
      'Prada Sport',
      'Pyre Moss',
      'Raf Simons',
      'Ralph Lauren',
      'Ralph Lauren Collection',
      'Ralph Lauren Purple Label',
      'RED Valentino',
      'Rhude',
      'Rick Owens',
      'Roberto Cavalli',
      'Roberto Cavalli Beachwear',
      'Roberto Cavalli Gym',
      'Sacai',
      'Saint Laurent Paris',
      'Salvatore Ferragamo',
      'Sandro',
      'Stone Island',
      'Stussy',
      'Supreme',
      'Tadashi Shoji',
      'TAO Comme des garcons',
      'Tom Ford',
      'Undercover',
      'Valentino',
      'Valentino Jeans',
      'Valentino Miss V',
      'Valentino T Shirt Couture',
      'Versace',
      'Versace Classic V2',
      'Versace Collection',
      'Versace Jeans',
      'Versace Jeans Couture',
      'Versace Signature',
      'Versus Versace',
      'Wako Maria',
      'Y-3',
      'Yeezy',
      'Yeezy x Adidas',
      'Yves Saint Laurent',
      'Yves Saint Laurent Variation',
      'Z Zegna',
      'Zegna Sport',
      'Brand Not Listed',
    ],
    Shoes: [
      '424',
      'A Cold Wall',
      'Adidas By Raf Simons',
      'Air Jordans',
      'Alexander McQueen',
      'Alfred Dunhill',
      'Amiri',
      'Axel Arigato',
      'Balenciaga',
      'Balmain',
      'Berluti',
      'Bottega Veneta',
      'Brunello Cucinelli',
      'Burberry',
      'Burberry Brit',
      'Burberry London',
      'Burberry Prorsum',
      'Celine',
      'CH Carolina Herrera',
      'Chanel',
      'Christian Louboutin',
      'Christopher Kane',
      'Common Projects',
      'Craig Green',
      'D&G',
      'Dior',
      'Dolce & Gabbana',
      'Dsquared2',
      'Ermenegildo Zegna',
      'Fear of God',
      'Fendi',
      'Gianvito Rossi',
      'Giorgio Armani',
      'Giuseppe Zanotti',
      'Givenchy',
      'Golden Goose',
      'Gucci',
      'Hermes',
      'J.M.Weston',
      'J.W.Anderson',
      'Jimmy Choo',
      'John Elliott',
      'Jordan',
      'Kiko Kostadinov',
      'Lanvin',
      'Le Silla',
      'Loewe',
      'Loro Piana',
      'Louis Vuitton',
      'Marco de vincenzo',
      'Marni',
      'McQ by Alexander McQueen',
      'Moncler',
      'Moschino',
      'Nike LeBron',
      'Nike x Sacai',
      'Nike X Yeezy',
      'Off-White',
      'Off-White x Nike',
      'Palm Angels',
      'Pharrell Williams',
      'Prada',
      'Prada Sport',
      'Raf Simons',
      'Ralph Lauren',
      'Ralph Lauren Collection',
      'Rhude',
      'Rick Owens',
      'Saint Laurent Paris',
      'Salvatore Ferragamo',
      'Santoni',
      "Tod's",
      'Tom Ford',
      'Valentino',
      'Versace',
      'Y-3',
      'Yeezy',
      'Yeezy x Adidas',
      'Yves Saint Laurent',
      'Brand Not Listed',
    ],
    'Fine Jewelry': [
      'Alfieri & St. John',
      'Annamaria Camilli',
      'Bernhard H. Mayer',
      'Boucheron',
      'Buccellati',
      'Bvlgari',
      'Cartier',
      'Chanel',
      'Chaumet',
      'Chopard',
      'Damiani',
      'De Beers',
      'De Grisogono',
      'Dior',
      'Dolce & Gabbana',
      'Fred',
      'Georg Jensen',
      'Graff',
      'Gucci',
      'Harry Winston',
      'Hermes',
      'Louis Vuitton',
      'Marco Bicego',
      'Mauboussin',
      'Messika',
      'Montblanc',
      'Pasquale Bruni',
      'Piaget',
      'Pomellato',
      'Qeelin',
      'Roberto Coin',
      'Stefan Hafner',
      'Tasaki',
      'Tiffany & Co.',
      'Van Cleef & Arpels',
      'Versace',
      'Brand Not Listed',
    ],
    Watches: [
      'Aigner',
      'AquaMarin',
      'Audemars Piguet',
      'Balmain',
      'Baume & Mercier',
      'Bernhard H. Mayer',
      'Blancpain',
      'Boss By Hugo Boss',
      'Boucheron',
      'Breguet',
      'Breitling',
      'Burberry',
      'Bvlgari',
      'Carl F. Bucherer',
      'Cartier',
      'Chanel',
      'Charriol',
      'Chaumet',
      'Chopard',
      'Christophe Claret',
      'Citizen',
      'Concord',
      'Corum',
      'De Grisogono',
      'Dior',
      'Ebel',
      'Edox',
      'Emporio Armani',
      'Esprit',
      'Fendi',
      'Franck Muller',
      'Frederic Jouvenot',
      'Frederique Constant',
      'Gianfranco Ferre',
      'Giorgio Armani',
      'Girard Perregaux',
      'Givenchy',
      'Graff',
      'Graham',
      'Gucci',
      'Harry Winston',
      'HD3 Slyde',
      'Hermes',
      'Hublot',
      'Hysek',
      'Hyt',
      'IWC',
      'Jacob & Co.',
      'Jaeger LeCoultre',
      'Jaquet Droz',
      'JeanRichard',
      'Junghans',
      'Just Cavalli',
      'Lancaster',
      'Longines',
      'Louis Moinet',
      'Louis Vuitton',
      'Marc by Marc Jacobs',
      'Marc Jacobs',
      'Martin Braun',
      'Mauboussin',
      'Maurice Lacroix',
      'Michael Kors',
      'MICHAEL Michael Kors',
      'Mido',
      'Montblanc',
      'Montega',
      'Movado',
      'Nina Ricci',
      'Omega',
      'Oris',
      'Panerai',
      'Parmigiani',
      'Patek Philippe',
      'Paul Picot',
      'Pequignet',
      'Philip Stein',
      'Piaget',
      'Pierre Balmain',
      'Porsche Design',
      'Rado',
      'Raymond Weil',
      'Richard Mille',
      'Robergé',
      'Roberto Cavalli',
      'Rolex',
      'Romain Jerome',
      'S.T. Dupont',
      'Saint Laurent Paris',
      'Salvatore Ferragamo',
      'Swatch',
      'Tag Heuer',
      'Technomarine',
      'Tiffany & Co.',
      'Tissot',
      'Tonino Lamborghini',
      'Tudor',
      'U-Boat',
      'Ulysse Nardin',
      'Vacheron Constantin',
      'Valentino',
      'Van Cleef & Arpels',
      'Versace',
      'Zenith',
      'Brand Not Listed',
    ],
    'Home & Art': ['Brand Not Listed'],
    Other: ['Brand Not Listed'],
  };

  let tomSelectInstance = null;
  let phoneInputInstance = null;

  document.addEventListener('DOMContentLoaded', () => {
    // 1. Initialize Phone
    const phoneInput = document.querySelector('#contact-phone');
    if (phoneInput) {
      phoneInputInstance = window.intlTelInput(phoneInput, {
        initialCountry: 'sa',
        favCountries: ['sa', 'ae', 'kw', 'bh', 'qa', 'om'], // GC prioritized
        utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js',
      });
    }

    // Initialize Bands with default (Bags)
    const checked = document.querySelector('input[name="contact[Collection]"]:checked');
    if (checked) updateBrandList(checked.value);

    // Form logic
    const form = document.getElementById('ConsignForm');
    const backendUrl =
      "{{ section.settings.backend_url | default: 'https://consign-backend.ayoubelgrine.workers.dev' }}";
    const whatsappNumber = "{{ section.settings.whatsapp_number | default: 'YOUR_NUMBER' }}";

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Format phone before sending
        const fullPhone = phoneInputInstance
          ? phoneInputInstance.getNumber()
          : document.getElementById('contact-phone').value;
        document.getElementById('real-phone-input').value = fullPhone;

        // Validation
        const front = document.getElementById('file-front').files[0];
        const back = document.getElementById('file-back').files[0];
        if (!front || !back) {
          showToast('Please upload at least the Front and Back photos.', true);
          return;
        }

        // Brand Other check
        const brandVal = tomSelectInstance
          ? tomSelectInstance.getValue()
          : document.getElementById('brand-select').value;
        const otherVal = document.getElementById('brand-other-input').value;
        if (brandVal === 'Brand Not Listed' && !otherVal) {
          showToast('Please enter your Brand Name.', true);
          return;
        }

        showLoading(true);

        try {
          // 1. Get Files
          const fileInputs = ['file-front', 'file-back', 'file-side', 'file-inside', 'file-details'];
          let filesToUpload = [];

          fileInputs.forEach((id) => {
            const f = document.getElementById(id).files[0];
            if (f) filesToUpload.push(f);
          });

          // 2. Sign Uploads
          const signRes = await fetch(`${backendUrl}/api/sign-upload`, {
            method: 'POST',
            body: JSON.stringify({
              files: filesToUpload.map((f) => ({
                filename: f.name,
                mimeType: f.type,
                fileSize: f.size,
              })),
            }),
            headers: { 'Content-Type': 'application/json' },
          });

          if (!signRes.ok) {
            let errMsg = 'Upload Setup Failed';
            try {
              const errData = await signRes.json();
              errMsg = errData.error || errData.message || JSON.stringify(errData);
            } catch (e) {
              errMsg = await signRes.text();
            }
            throw new Error(errMsg);
          }
          const signData = await signRes.json();
          const targets = signData.stagedTargets;

          // 3. Upload to Shopify
          const uploadPromises = filesToUpload.map((file, i) => {
            const target = targets[i];
            const formData = new FormData();
            target.parameters.forEach((p) => formData.append(p.name, p.value));
            formData.append('file', file);

            return fetch(target.url, { method: 'POST', body: formData }).then(() => target.resourceUrl);
          });

          const uploadedResourceUrls = await Promise.all(uploadPromises);

          // 4. Submit Data
          const formData = new FormData(form);
          const payload = {
            uploadedResources: uploadedResourceUrls,
            formData: Object.fromEntries(formData.entries()),
          };

          // Cleanup
          ['file_front', 'file_back', 'file_side', 'file_inside', 'file_details', 'contact[phone_raw]'].forEach(
            (k) => delete payload.formData[k]
          );

          // Ensure correct brand
          if (payload.formData['contact[Brand]'] === 'Brand Not Listed') {
            payload.formData['contact[Brand]'] = payload.formData['contact[Brand_Custom]'];
          }

          const finalRes = await fetch(`${backendUrl}/api/submit-consign`, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' },
          });

          if (!finalRes.ok) throw new Error('Submission failed');

          // Success
          const dateCodes = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const random4 = Math.floor(1000 + Math.random() * 9000);
          const refId = `SBS-${dateCodes}-${random4}`;

          showSuccess(refId);
        } catch (err) {
          console.error(err);
          if (err.name !== 'SyntaxError') {
            showToast('Note: ' + err.message, true);
          } else {
            showToast('An unexpected error occurred. Please try again.', true);
          }
          showLoading(false);
        }
      });
    }
  });

  function updateBrandList(collection) {
    const brandSelect = document.getElementById('brand-select');
    const otherInput = document.getElementById('brand-other-input');

    // Destroy existing TomSelect if it exists
    if (tomSelectInstance) {
      tomSelectInstance.destroy();
      tomSelectInstance = null;
    }

    brandSelect.innerHTML = '';

    const brands = brandData[collection] || brandData['Other'];

    // Add empty option for placeholder
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.text = 'Select Brand...';
    brandSelect.appendChild(placeholder);

    brands.forEach((brand) => {
      const option = document.createElement('option');
      if (brand === 'Select Brand') return; // Skip "Select Brand" from array if legacy

      option.value = brand;
      option.text = brand;
      brandSelect.appendChild(option);
    });

    // Special case handling
    const isSingleOption = brands.length === 1 && brands[0] === 'Brand Not Listed';

    // Re-init TomSelect
    tomSelectInstance = new TomSelect('#brand-select', {
      create: false,
      sortField: {
        field: 'text',
        direction: 'asc',
      },
      placeholder: 'Search or select a brand...',
      maxOptions: 200,
      onChange: function (value) {
        checkBrandOther(value);
      },
    });

    // Handle "Other" input visibility
    otherInput.style.display = 'none';
    otherInput.required = false;

    if (isSingleOption) {
      tomSelectInstance.setValue('Brand Not Listed');
      // checkBrandOther triggered by onChange usually, but force check
      checkBrandOther('Brand Not Listed');
    }
  }

  function checkBrandOther(value) {
    const otherInput = document.getElementById('brand-other-input');
    if (value === 'Brand Not Listed') {
      otherInput.style.display = 'block';
      otherInput.required = true;
      otherInput.focus();
    } else {
      otherInput.style.display = 'none';
      otherInput.required = false;
      otherInput.value = '';
    }
  }

  function triggerFile(id) {
    document.getElementById(id).click();
  }

  function previewFile(input, imgId) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.getElementById(imgId);
        img.src = e.target.result;
        img.style.display = 'block';

        const box = img.closest('.upload-box');
        box.classList.add('has-file');

        // Styles handled by CSS class now
        // box.querySelector('.remove-btn').style.display = 'flex';
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function removeFile(e, inputId, imgId) {
    e.stopPropagation();

    const input = document.getElementById(inputId);
    input.value = '';

    const img = document.getElementById(imgId);
    img.style.display = 'none';
    img.src = '';

    document.getElementById(imgId + '-placeholder').style.display = 'block';

    const box = e.target.closest('.upload-box');
    box.classList.remove('has-file');
  }

  function showLoading(show) {
    const el = document.getElementById('consign-loading');
    if (show) el.classList.add('active');
    else el.classList.remove('active');
  }

  function showSuccess(refId) {
    showLoading(false);
    document.getElementById('consign-success').classList.add('active');
    if (refId) {
      document.getElementById('success-ref-id').innerText = '#' + refId;

      const whatsappLink = document.getElementById('success-whatsapp-link');
      const text = `Hi, I submitted item #${refId}. I'm waiting for pricing guidance.`;
      if (whatsappLink) whatsappLink.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(text)}`;
    }
  }

  function showToast(message, isError = false) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${isError ? 'error' : ''}`;
    toast.innerHTML = `<span>${message}</span>`;

    container.appendChild(toast);

    // Trigger reflow
    void toast.offsetWidth;
    toast.classList.add('show');

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 300);
    }, 4000);
  }
</script>

{% schema %}
{
  "name": "Consign Dashboard",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_hero",
      "label": "Show Hero Section",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "banner_bg",
      "label": "Banner Background"
    },
    {
      "type": "range",
      "id": "banner_height",
      "min": 150,
      "max": 600,
      "step": 10,
      "unit": "px",
      "label": "Banner Height",
      "default": 220
    },
    {
      "type": "header",
      "content": "Banner Text"
    },
    {
      "type": "liquid",
      "id": "hero_title",
      "label": "Headline",
      "default": "Sell with <br> SO. by Sora"
    },
    {
      "type": "color",
      "id": "color_title",
      "label": "Headline Color",
      "default": "#ffffff"
    },
    {
      "type": "textarea",
      "id": "hero_text",
      "label": "Description",
      "default": "Sell Your Luxury Items the Easy Way.\nWe handle the selling so your pieces can find their next home and you get paid."
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "Description Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Configuration"
    },
    {
      "type": "text",
      "id": "backend_url",
      "label": "Backend Worker URL",
      "default": "https://consign-backend.ayoubelgrine.workers.dev",
      "info": "The URL of your Cloudflare Worker backend."
    },
    {
      "type": "text",
      "id": "whatsapp_number",
      "label": "WhatsApp Number",
      "default": "1234567890",
      "info": "Your WhatsApp number in international format (e.g., 966500000000) without '+'."
    }
  ],
  "presets": [
    {
      "name": "Consign Dashboard"
    }
  ]
}
{% endschema %}
